# GoClaw

[![CI](https://github.com/zkoranges/go-claw/actions/workflows/ci.yml/badge.svg)](https://github.com/zkoranges/go-claw/actions/workflows/ci.yml)
[![Go](https://img.shields.io/badge/Go-1.24+-00ADD8?logo=go&logoColor=white)](https://go.dev)
[![SQLite](https://img.shields.io/badge/SQLite-WAL-003B57?logo=sqlite&logoColor=white)](https://sqlite.org)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![Status](https://img.shields.io/badge/Status-WIP-orange)](#status)

> **Work in progress.** GoClaw is under active development. APIs, config formats, and internals may change without notice. Not yet recommended for production use.

A durable local orchestration kernel for AI agents. Single binary, single user, crash-recoverable.

GoClaw runs a local daemon that accepts agent tasks over a WebSocket protocol (ACP), persists them in SQLite, executes them through an LLM brain with tool access, and guarantees that no work is silently lost — even under `kill -9`.

## What it does

- **Durable task queue** backed by SQLite WAL. Tasks survive crashes and restarts. Lease-based ownership with automatic recovery of orphaned work.
- **8-state task machine** (QUEUED, CLAIMED, RUNNING, RETRY_WAIT, SUCCEEDED, FAILED, CANCELED, DEAD_LETTER) with transactional state transitions and append-only event audit trail.
- **Multi-agent support.** Named agents with independent brains, worker pools, and task queues. Agents can be defined in `config.yaml` and hot-reloaded at runtime.
- **ACP WebSocket gateway** implementing JSON-RPC 2.0 with version negotiation, bearer token auth, cursor-based replay, and explicit backpressure signaling.
- **LLM brain** via Genkit + Gemini (with multi-provider failover to Anthropic, OpenAI, and OpenRouter). Tool calls are schema-validated before execution.
- **Default-deny policy engine** with capability-based access control and domain allowlists. Policy hot-reloads via fsnotify; invalid config fails closed.
- **WASM skill sandbox** via wazero with memory limits, CPU fuel metering, execution timeouts, fault-count quarantine, and two-phase hot reload with rollback.
- **Built-in tools**: shell execution (with optional Docker sandboxing), filesystem operations, web search (Brave / Perplexity / DuckDuckGo), MCP client, process spawning.
- **Operational TUI** (Bubbletea) with interactive chat, agent switching (`/agent`), skill management, and model selection.
- **Cron scheduler** for recurring tasks with 5-field cron expressions.
- **Multi-channel input**: Telegram bot integration (with `@agent` routing), OpenAI-compatible `/v1/chat/completions` endpoint.
- **Structured observability**: JSON logs, dual-write audit (file + DB), `/healthz` and `/metrics` endpoints.

## What it does not do

- **No browser automation.** No Chromium, no Puppeteer, no headless rendering.
- **No distributed clustering.** Single-node, single-process. No multi-node scheduling, no consensus protocol.
- **No multi-tenancy.** One user context per daemon process. No user isolation within a single instance.
- **No mobile or desktop clients.** TUI and WebSocket are the interfaces.
- **No guaranteed exactly-once execution.** Semantics are at-least-once for tasks, at-most-once per idempotency key for side effects. Downstream tools must be idempotent.

## Status

**v0.1-dev** — under active development.

The core subsystems (persistence, engine, gateway, policy, WASM sandbox, multi-agent) are implemented and tested. The project is undergoing refactoring and is not yet stable. Spec: [SPEC.md](SPEC.md).

## Build and run

Requires Go 1.24+ and a `GEMINI_API_KEY` in `.env` or environment.

```bash
just build          # compile to /tmp/goclaw
just run            # build + launch (interactive TUI)
just run-headless   # build + launch (no TUI, logs to stdout)
just test           # go test ./... -count=1
just check          # build + vet + test
just fmt            # format all Go files
```

First run creates `~/.goclaw/` with `config.yaml`, `policy.yaml`, `SOUL.md`, `auth.token`, and the SQLite database.

## Configuration

All state lives under `GOCLAW_HOME` (default `~/.goclaw`):

```
~/.goclaw/
  config.yaml       # Runtime config (YAML, env var overlay, agent hot-reload)
  policy.yaml       # Capability allowlists, domain allowlists
  goclaw.db         # SQLite (WAL mode, synchronous=FULL)
  auth.token        # Bearer token (auto-generated on first run)
  SOUL.md           # Agent identity (generated by genesis wizard)
  skills/           # User WASM skills and SKILL.md definitions
  logs/
    system.jsonl    # Structured operational logs
    audit.jsonl     # Append-only security audit log
```

Precedence: environment variables > `config.yaml` > defaults.

## Project layout

```
cmd/goclaw/          Daemon entry point, CLI subcommands
internal/
  persistence/       SQLite store, schema migrations, task queue
  engine/            Task execution engine, worker lanes, brain integration
  gateway/           ACP WebSocket server, REST API, OpenAI-compat endpoint
  policy/            Default-deny policy engine, hot-reload
  audit/             Dual-write audit (JSONL + DB)
  sandbox/wasm/      WASM host (wazero), resource limits, quarantine
  sandbox/legacy/    Legacy shell skill bridge (restricted)
  skills/            Skill loader, installer, SKILL.md parser
  tools/             Built-in tools, search providers, MCP bridge
  agent/             Multi-agent registry, scoped execution
  config/            YAML config, env overlay, fsnotify watcher
  channels/          Telegram integration
  mcp/               MCP client (stdio + SSE)
  cron/              Cron scheduler
  tui/               Bubbletea TUI
  bus/               In-process event bus
  safety/            Input sanitization
  doctor/            Startup self-checks
  telemetry/         Structured logging setup
```

## Documentation

| Document | Purpose |
|---|---|
| [SPEC.md](SPEC.md) | System specification |
| [PDR.md](PDR.md) | Product design rationale |

## License

[MIT](LICENSE)
